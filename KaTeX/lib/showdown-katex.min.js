(function(root) {
  function _escapeHtml(s) {
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function _render(expr, options, displayMode) {
    if (!root.katex || typeof root.katex.renderToString !== 'function') {
      return displayMode
        ? '<pre><code>' + _escapeHtml(expr) + '</code></pre>'
        : '<code>' + _escapeHtml(expr) + '</code>';
    }

    try {
      var opts = {};
      for (var k in options) {
        if (Object.prototype.hasOwnProperty.call(options, k)) opts[k] = options[k];
      }
      opts.displayMode = displayMode;
      if (typeof opts.throwOnError === 'undefined') opts.throwOnError = false;
      return root.katex.renderToString(expr, opts);
    } catch (e) {
      return displayMode
        ? '<pre><code>' + _escapeHtml(expr) + '</code></pre>'
        : '<code>' + _escapeHtml(expr) + '</code>';
    }
  }

  function _factory(options) {
    options = options || {};
    return [
      {
        type: 'lang',
        regex: /\$\$([\s\S]+?)\$\$/g,
        replace: function(_m, expr) {
          return _render(expr, options, true);
        }
      },
      {
        type: 'lang',
        regex: /\\\[([\s\S]+?)\\\]/g,
        replace: function(_m, expr) {
          return _render(expr, options, true);
        }
      },
      {
        type: 'lang',
        regex: /(^|[^\\])\\\(([\s\S]+?)\\\)/g,
        replace: function(_m, prefix, expr) {
          return prefix + _render(expr, options, false);
        }
      },
      {
        type: 'lang',
        regex: /(^|[^\\])\$(?!\$)([^\n$]+?)\$(?!\$)/g,
        replace: function(_m, prefix, expr) {
          return prefix + _render(expr, options, false);
        }
      }
    ];
  }

  root.showdownKatex = function(options) {
    return _factory(options);
  };
})(typeof window !== 'undefined' ? window : this);
