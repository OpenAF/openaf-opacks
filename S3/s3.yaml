jobs:
  # ---------------------
  - name : S3 Make bucket
    help : 
      text   : "Creates a S3 bucket."
      expects:
      - name    : url
        desc    : The S3 endpoint URL
        required: true
      - name    : bucket
        desc    : The S3 bucket name
        required: true
      - name    : accessKey
        desc    : The access key to the S3 service
        required: false
      - name    : secret
        desc    : The secret key to the S3 service
        required: false
      - name    : region
        desc    : The S3 region
        required: false
    check:
      in:
        url      : isString
        bucket   : isString
        accessKey: isString.default(__)
        secret   : isString.default(__)
        region   : isString.default(__)
    exec : |
      loadLib("s3.js")
      var s3 = new S3(args.url, args.accessKey, args.secret, args.region)
      s3.makeBucket(args.bucket, args.region)
      
  # --------------
  - name : S3 List
    help :
      text   : Retrieves the list of objects in a S3 Bucket. If successfull the list will be output to args.list.
      expects:
      - name    : url
        desc    : The S3 endpoint URL
        required: true
      - name    : bucket
        desc    : The S3 bucket name
        required: true
      - name    : accessKey
        desc    : The access key to the S3 service
      - name    : secret
        desc    : The secret key to the S3 service
      - name    : region
        desc    : The S3 region
      - name    : objectPrefix
        desc    : The object prefix
      - name    : needFull
        desc    : Boolean to determine if the list needs to include the contentType (default false)
      - name    : needRecursive
        desc    : Boolean to determine if the list should recursive (default false)
      - name    : metric
        desc    : Identify the oJob metric to use (only for openaf version > 20211103)
    check:
      in:
        url          : isString
        bucket       : isString
        accessKey    : isString.default(__)
        secret       : isString.default(__)
        objectPrefix : isString.default(__)
        needFull     : toBoolean.isBoolean.default(false)
        needRecursive: toBoolean.isBoolean.default(false)
        metric       : isString.default({__})
    exec : |
      var _met = {}
      if (isDef(args.metric)) _met = _$(ow.oJob.getMetric(args.metric)).isMap().default({})

      loadLib("s3.js");

      var t = now()
      var s3 = new S3(args.url, args.accessKey, args.secret, args.region);
      _met.connTime = now() - t

      if (isDef(args.metric)) {
        ow.loadNet()
        _met.socketLatency = ow.net.testURLLatency(args.url)
      }

      var listmetric = "ListObjects" + (args.needRecursive ? "Recursive" : "")
      t = now()
      args.list = s3.listObjects(args.bucket, args.objectPrefix, args.needFull, args.needRecursive);
      _met[listmetric + "Time"] = _$(_met[listmetric + "Time"]).isNumber().default(0) + (now() - t)
      _met[listmetric + "Ops"]  = _$(_met[listmetric + "Ops"]).isNumber().default(0) + 1
      if (isArray(args.list)) _met[listmetric + "ResultCount"] = _$(_met[listmetric + "ResultCount"]).isNumber().default(0) + args.list.length

      if (isDef(args.metric)) {
        _met.id          = args.metric
        _met.type        = "s3"
        ow.oJob.setMetric(args.metric, _met)
      }
      
  #------------------------
  - name : S3 Remove bucket
    help :
      text   : Removes a S3 bucket.
      expects:
      - name    : url
        desc    : The S3 endpoint URL
        required: true
      - name    : bucket
        desc    : The S3 bucket name
        required: true
      - name    : accessKey
        desc    : The access key to the S3 service
      - name    : secret
        desc    : The secret key to the S3 service
      - name    : region
        desc    : The S3 region
    check:
      in:
        url      : isString
        bucket   : isString
        accessKey: isString.default(__)
        secret   : isString.default(__)
        region   : isString.default(__)
    exec : |      
      loadLib("s3.js");
      var s3 = new S3(args.url, args.accessKey, args.secret, args.region);
      s3.removeBucket(args.bucket);       

  #---------------------
  - name : S3 Put object
    help :
      text   : Sends an object to a S3 bucket.
      expects:
      - name    : url
        desc    : The S3 endpoint URL
        required: true
      - name    : bucket
        desc    : The S3 bucket name
        required: true
      - name    : accessKey
        desc    : The access key to the S3 service
      - name    : secret
        desc    : The secret key to the S3 service
      - name    : region
        desc    : The S3 region
      - name    : objectName
        desc    : The S3 object name to use
      - name    : localPath
        desc    : The local path file to send to the bucket
      - name    : meta 
        desc    : The meta map object to add to the object
    check:
      in:
        url       : isString
        bucket    : isString
        accessKey : isString.default(__)
        secret    : isString.default(__)
        objectName: isString
        localPath : isString
        meta      : isMap.default(__)
    exec : |
      loadLib("s3.js");
      var s3 = new S3(args.url, args.accessKey, args.secret, args.region);
      s3.putObject(args.bucket, args.objectName, args.localPath, args.meta);  

  # --------------------
  - name : S3 Get object
    help :
      text   : Retrieves an object from a S3 bucket.
      expects:
      - name    : url
        desc    : The S3 endpoint URL
        required: true
      - name    : bucket
        desc    : The S3 bucket name
        required: true
      - name    : accessKey
        desc    : The access key to the S3 service
      - name    : secret
        desc    : The secret key to the S3 service
      - name    : region
        desc    : The S3 region
      - name    : objectName
        desc    : The S3 object name to use
        required: true
      - name    : localPath
        desc    : The local path to store the object
        required: true
    check:
      in:
        url       : isString
        bucket    : isString
        accessKey : isString.default(__)
        secret    : isString.default(__)
        region    : isString.default(__)
        objectName: isString
        localPath : isString
    exec : |
      loadLib("s3.js");
      var s3 = new S3(args.url, args.accessKey, args.secret, args.region);
      s3.getObject(args.bucket, args.objectName, args.localPath);

  # ----------------------
  - name: S3 Remove object
    help: 
      text   : Removes an object from a S3 bucket.
      expects:
      - name    : url
        desc    : The S3 endpoint URL
        required: true
      - name    : bucket
        desc    : The S3 bucket name
        required: true
      - name    : accessKey
        desc    : The access key to the S3 service
      - name    : secret
        desc    : The secret key to the S3 service
      - name    : region
        desc    : The S3 region
      - name    : objectName
        desc    : The S3 object name to remove
        required: true
    check:
      in:
        url       : isString
        bucket    : isString
        accessKey : isString.default(__)
        secret    : isString.default(__)
        region    : isString.default(__)
        objectName: isString
    exec: | 
      loadLib("s3.js");
      var s3 = new S3(args.url, args.accessKey, args.secret, args.region);
      s3.removeObject(args.bucket, args.objectName);

  # ---------------------
  - name : S3 Copy object
    help : 
      text   : Copy an object between S3 buckets.
      expects:
      - name    : url
        desc    : The S3 endpoint URL
        required: true
      - name    : accessKey
        desc    : The access key to the S3 service
      - name    : secret
        desc    : The secret key to the S3 service
      - name    : region
        desc    : The S3 region
      - name    : sourceBucket
        desc    : The S3 source bucket
        required: true
      - name    : sourceObject
        desc    : The S3 source object name
        required: true
      - name    : targetBucket
        desc    : The S3 target bucket
        required: true
      - name    : targetObject
        desc    : The S3 target object name
        required: true
      - name    : meta
        desc    : Change the S3 target object map metadata
      - name    : copyOptions
        desc    : Optionally specify a map with matchETag (string), matchETagNone (string), modified, unmodified
    check:
      in:
        url         : isString
        bucket      : isString
        accessKey   : isString.default(__)
        secret      : isString.default(__)
        sourceBucket: isString
        sourceObject: isString
        targetBucket: isString
        targetObject: isString
        meta        : isMap.default(__)
        copyOptions : isMap.default(__)
    exec : |
      loadLib("s3.js");
      var s3 = new S3(args.url, args.accessKey, args.secret, args.region);
      s3.copyObject(args.sourceBucket, args.sourceObject, args.targetBucket, args.targetObject, args.meta, args.copyOptions);