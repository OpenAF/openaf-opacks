author: Nuno Aguiar
scripts:
  preerase: ''
  posterase: |
    ow.loadFormat()
    var isWin = ow.format.isWindows()

    // If opack installed near OpenAF
    if (io.fileExists(getOpenAFPath() + "oafp")) {
      logWarn("Removing " + getOpenAFPath() + "oafp...")
      io.rm(getOpenAFPath() + "oafp")
    }

    // If Linux and root, install in /usr/bin or /bin if oaf is there also
    if (!isWin && ow.format.getUserName() == "root") {
      if (io.fileExists("/usr/bin/oafp")) {
        logWarn("Removing /usr/bin/oafp...")
        io.rm("/usr/bin/oafp")
      }
      if (io.fileExists("/bin/oafp")) {
        logWarn("Removing /bin/oafp...")
        io.rm("/bin/oafp")
      }
    }

    // If opack installed in user space
    if (getOpenAFPath().startsWith(String(java.lang.System.getProperty("java.io.tmpdir")) + "/_oaf_")) {
      if (io.rm("oafp")) logWarn("Removing oafp...")
    }
  preinstall: ''
  postinstall: |
    var installPath
    ow.loadFormat()
    var isWin = ow.format.isWindows()

    if (outputPath.startsWith(getOpenAFPath())) {
      // If opack installed near OpenAF
      log("Installing 'oafp' in " + getOpenAFPath() + "...")
      io.cp(outputPath + "/oafp.js", getOpenAFPath() + "oafp.js")
      $sh(getOpenAFPath() + "oaf --sb " + getOpenAFPath() + "oafp.js").exec()
      log("Renaming oafp.js to oafp...")
      io.mv(getOpenAFPath() + "oafp.js", getOpenAFPath() + "oafp")
      installPath = getOpenAFPath() + "oafp"

      // If Linux and root, install in /usr/bin or /bin if oaf is there also
      if (!isWin && ow.format.getUserName() == "root") {
        var installIn = __
        if (io.fileExists("/usr/bin/oaf")) installIn = "/usr/bin"
        if (io.fileExists("/bin/oaf"))     installIn = "/bin"
        if (isDef(installIn)) {
          io.writeFileString(installIn + "/oafp", "#!/bin/sh\n" + installPath + " \"$@\"\n")
          $sh("chmod a+x " + installIn + "/oafp").exec()
        }
      }
    } else {
      // If opack installed in user space
      log("Creating 'oafp'...")
      io.cp(outputPath + "/oafp.js", "oafp.js")
      $sh(getOpenAFPath() + "oaf --sb oafp.js").exec()
      log("Renaming oafp.js to oafp...")
      io.mv("oafp.js", "oafp")
      installPath = "oafp"
    }
    if (!isWin) $sh("chmod a+x " + installPath).exec()

    // If windows, build script
    if (isWin) {
      log("Building oafp.bat...")
      io.writeFileString(installPath + ".bat", "@echo off\nset thispath=%~dp0\nset DIR=%thispath:~0,-1%\nset OAF_DIR=\"%DIR%\"\nchcp 65001 > NUL\n%OAF_DIR%/oaf.bat -f %OAF_DIR%/oafp -e \"%*\"")
    }

    // Determine if it's static install
    if (getOpenAFPath().startsWith(String(java.lang.System.getProperty("java.io.tmpdir")) + "/_oaf_")) {
      log("Static install detected.")
      $sh("ln -s " + installPath + " oafp").exec()
      installPath = "oafp"
    }

    print("\n --> Run '" + (installPath.indexOf("/") < 0 ? "./"+installPath : installPath) + " -h' for usage details <--\n")
keywords:
- data
- processor
- yaml
- json
- xml
- csv
- ndjson
- slon
- md
- visualisation
- oafp
- query
- jmespath
- nlinq
- transformer
- filter
- parser
- template
- visualization
- data-processing
bugs:
  url: https://github.com/OpenAF/openaf-opacks/issues
repository:
  type: http
  url: https://openaf.io/opacks/oafproc.opack
description: A command-line data processor for various input and output formats with query capabilities.
name: oafproc
main: oafp.js
mainJob: ''
license: https://github.com/OpenAF/openaf-opacks/blob/master/LICENSE
version: '20240210'
dependencies:
  openaf: '>=20231222'
files:
- .package.yaml
- README.md
- build/build.yaml
- build/oafp.source.js
- buildStaticOAFP.yaml
- docs/EXAMPLES.md
- docs/FILTERS.md
- docs/TEMPLATE.md
- docs/USAGE.md
- oafp.js
- oafp.yaml
- tests/autoTest.js
- tests/autoTest.yaml
filesHash:
  README.md: 896dd498c723a8a1301ba46d1df347263403b3f6
  build/build.yaml: 7548c8db8d109081d85a111ff2cd3767b2c20ade
  build/oafp.source.js: f792a0861633aad2864a74d8dc746d611fcff424
  buildStaticOAFP.yaml: 3cfba475fdd4c1cb8c7fc90c4462647805626b75
  docs/EXAMPLES.md: 159ee341a7f9ec9037b0171d5cd52ed360bd9a09
  docs/FILTERS.md: dfb37c26e533f74e679c7c7556f1b804c9e2bd74
  docs/TEMPLATE.md: d8db7efd206d9735d18b3524533725aa3da70930
  docs/USAGE.md: e3c681112005aee68be980bc4b3113174234a4bc
  oafp.js: cd744e37ebe3550e2988b54945e2379fd3ed6bd4
  oafp.yaml: b5450fc1d53df63262afba65f9f6b70ce8e6ba1d
  tests/autoTest.js: d075915c640f06f04abfffd19923ae5dd042bb31
  tests/autoTest.yaml: a3c8109a2b1386a2ef9a68831336ee8c655f0409
